import 'dart:convert';
import 'dart:io';

import 'package:path/path.dart' as Path;
import 'package:git/git.dart';
import 'package:which/which.dart' as Which;

main() async {
  var pubExec = await Which.which('pub');
  var targetBranch = 'gh-pages';
  var targetDir = 'web';
  var commitMessage = 'autogenerated gh-pages';
  var gitDir = await GitDir.fromExisting(Path.current);

  // create a temp dir to dump 'pub build' output to
  Directory tempDir = await Directory.systemTemp.createTemp('ghp.$_secondsSinceEpoch.');

  try {
    var pubArgs = ['build', '--output', tempDir.path, targetDir];
    await execute(pubExec, pubArgs);

    Commit commit = await gitDir.updateBranchWithDirectoryContents(
        targetBranch, Path.join(tempDir.path, targetDir), commitMessage);

    if (commit == null) {
      print('There was no change in branch. No commit created.');
    } else {
      print('Branch "$targetBranch" was updated with "pub build" output from "$targetDir".');
    }
  } catch (e, stack) {
    print(e);
    if (e is! String) {
      print(stack);
    }
  } finally {
    await tempDir.delete(recursive: true);
  }
}

execute(String exec, List<String> args) async {
  Process process = await Process.start(exec, args);

  process.stdout.transform(_lineDecoder).listen((line) {
    stdout.writeln(line);
  });

  process.stderr.transform(_lineDecoder).listen((line) {
    stderr.writeln(line);
  });

  var exitCode = await process.exitCode;

  if (exitCode != 0) {
    throw 'Error running $exec ${args.join(' ')}';
  }
}

int _secondsSinceEpoch = new DateTime.now().toUtc().millisecondsSinceEpoch;

final _lineDecoder = SYSTEM_ENCODING.decoder.fuse(const LineSplitter());