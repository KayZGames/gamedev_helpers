import 'dart:async';
import 'dart:convert';
import 'dart:io';

import 'package:path/path.dart' as path;
import 'package:git/git.dart';
import 'package:which/which.dart' as which;

Future<Null> main() async {
  final pubExec = await which.which('pub');
  final targetBranch = 'gh-pages';
  final targetDir = 'web';
  final commitMessage = 'autogenerated gh-pages';
  final gitDir = await GitDir.fromExisting(path.current);

  // create a temp dir to dump 'pub build' output to
  final Directory tempDir =
      await Directory.systemTemp.createTemp('ghp.$_secondsSinceEpoch.');

  try {
    final pubArgs = ['build', '--output', tempDir.path, targetDir];
    await execute(pubExec, pubArgs);

    final Commit commit = await gitDir.updateBranchWithDirectoryContents(
        targetBranch, path.join(tempDir.path, targetDir), commitMessage);

    if (commit == null) {
      print('There was no change in branch. No commit created.');
    } else {
      print(
          'Branch "$targetBranch" was updated with "pub build" output from "$targetDir".');
    }
  } catch (e, stack) {
    print(e);
    if (e is! String) {
      print(stack);
    }
  } finally {
    await tempDir.delete(recursive: true);
  }
}

Future<Null> execute(String exec, List<String> args) async {
  final Process process = await Process.start(exec, args);

  process.stdout.transform(_lineDecoder).listen((line) {
    stdout.writeln(line);
  });

  process.stderr.transform(_lineDecoder).listen((line) {
    stderr.writeln(line);
  });

  final exitCode = await process.exitCode;

  if (exitCode != 0) {
    throw 'Error running $exec ${args.join(' ')}';
  }
}

int _secondsSinceEpoch = new DateTime.now().toUtc().millisecondsSinceEpoch;

final Converter<List<int>, List<String>> _lineDecoder = SYSTEM_ENCODING.decoder
    .fuse<List<String>>(
        const LineSplitter() as Converter<String, List<String>>);
